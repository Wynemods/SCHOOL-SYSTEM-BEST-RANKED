<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin Panel - User Management</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            color: #1f2937;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 28px;
            font-weight: 700;
        }
        
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 16px;
        }
        
        .nav {
            background: #f8fafc;
            padding: 15px 25px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            gap: 15px;
        }
        
        .nav a {
            color: #374151;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .nav a:hover {
            background: #e5e7eb;
        }
        
        .nav a.active {
            background: #16a34a;
            color: white;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 30px;
        }
        
        .section h2 {
            color: #1f2937;
            margin: 0 0 20px 0;
            font-size: 22px;
            font-weight: 600;
            border-bottom: 2px solid #16a34a;
            padding-bottom: 10px;
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        .data-table th {
            background: #f8fafc;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .data-table td {
            padding: 15px 12px;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .data-table tr:hover {
            background-color: #f9fafb;
        }
        
        .status-approved {
            color: #16a34a;
            font-weight: 600;
        }
        
        .status-pending {
            color: #f59e0b;
            font-weight: 600;
        }
        
        .status-locked {
            color: #ef4444;
            font-weight: 600;
        }
        
        .btn {
                    padding: 8px 16px;
                    border: none;
                    border-radius: 6px;
                    font-size: 12px;
                    font-weight: 500;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    display: inline-flex;
                    align-items: center;
                    gap: 5px;
                }
                
                .btn-approve {
                    background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
                    color: white;
                }
                
                .btn-approve:hover {
                    background: linear-gradient(135deg, #15803d 0%, #166534 100%);
                    transform: translateY(-1px);
                }
                
                .btn-reject {
                    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
                    color: white;
                }
                
                .btn-reject:hover {
                    background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
                    transform: translateY(-1px);
                }
                
                .btn-lock {
                    background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
                    color: white;
                }
                
                .btn-lock:hover {
                    background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
                    transform: translateY(-1px);
                }
                
                .btn-unlock {
                    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                    color: white;
                }
                
                .btn-unlock:hover {
                    background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
                    transform: translateY(-1px);
                }
                
                .status-badge {
                    display: inline-block;
                    padding: 4px 10px;
                    border-radius: 20px;
                    font-size: 12px;
                    font-weight: 600;
                    text-transform: uppercase;
                }
                
                .status-active {
                    background: #dcfce7;
                    color: #16a34a;
                    border: 1px solid #bbf7d0;
                }
                
                .status-pending {
                    background: #fef3c7;
                    color: #f59e0b;
                    border: 1px solid #fde68a;
                }
                
                .status-locked {
                    background: #fee2e2;
                    color: #ef4444;
                    border: 1px solid #fecaca;
                }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            text-align: center;
            border: 1px solid #e5e7eb;
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: #16a34a;
            margin: 0 0 10px 0;
        }
        
        .stat-label {
            color: #6b7280;
            font-size: 14px;
            font-weight: 500;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        
        .notification.success {
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
        }
        
        .notification.error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
                    }
                                         
                                         .btn svg {
                                                                  flex-shrink: 0;
                                                              }
                                                              
                                                              .action-cell {
                                                                  display: flex;
                                                                  flex-wrap: wrap;
                                                                  gap: 5px;
                                                              }
                                                              
                                                              .action-cell .btn {
                                                                  white-space: nowrap;
                                                              }
                                                              
                                                              #user-search {
                                                                  padding: 8px 12px;
                                                                  border: 1px solid #ddd;
                                                                  border-radius: 4px;
                                                                  font-size: 14px;
                                                                  width: 200px;
                                                              }
                                                              
                                                              #user-search:focus {
                                                                  outline: none;
                                                                  border-color: #16a34a;
                                                                  box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.1);
                                                              }
                                              </style>
                                          </head>
                                          <body>
                                              <div id="notification" class="notification" style="display:none;"></div>
                                              <input type="hidden" id="csrf-token" value="YOUR_CSRF_TOKEN_HERE" />
                         
                         <div class="container">
        <div class="header">
            <h1>📊 Admin Panel</h1>
            <p>User Management & System Administration</p>
        </div>
        
        <div class="nav">
            <a href="#" class="active">👥 User Management</a>
                        <a href="/main-library-dashboard.html">📚 Library Dashboard</a>
                        <a href="/index-landing.html">🏠 Home</a>
        </div>
        
        <div class="content">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="total-users">0</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pending-users">0</div>
                    <div class="stat-label">Pending Approval</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="active-users">0</div>
                    <div class="stat-label">Active Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="locked-users">0</div>
                    <div class="stat-label">Locked Users</div>
                </div>
            </div>
                        
                        <div class="section">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                            <h2>👥 User Management</h2>
                                            <div style="display: flex; gap: 10px;">
                                                <input type="text" id="user-search" placeholder="Search users..." style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px;">
                                                <button class="btn btn-approve" onclick="searchUsers()" style="padding: 10px 20px;">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <circle cx="11" cy="11" r="8"></circle>
                                                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                                    </svg>
                                                    Search
                                                </button>
                                                <button class="btn btn-approve" onclick="loadUsers()" style="padding: 10px 20px;">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                                                        <path d="M3 3v5h5"></path>
                                                        <path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"></path>
                                                        <path d="M16 16h5v5"></path>
                                                    </svg>
                                                    Refresh
                                                </button>
                                            </div>
                                        </div>
                            <div class="table-container">
                                <table class="data-table" id="users-table">
                                    <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Approved</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let users = [];
        
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        async function loadUsers() {
            try {
                const response = await fetch('/api/users');
                if (!response.ok) throw new Error('Failed to fetch users');
                
                users = await response.json();
                renderUsers();
                updateStats();
            } catch (error) {
                showNotification('Error loading users: ' + error.message, 'error');
            }
        }
        
        function renderUsers() {
            const tbody = document.querySelector('#users-table tbody');
            tbody.innerHTML = '';
            
            users.forEach(user => {
                const row = document.createElement('tr');
                
                const status = user.isLocked ? 'locked' : (user.isApproved ? 'active' : 'pending');
                const statusClass = `status-${status}`;
                
                row.innerHTML = `
                                    <td>${user.id}</td>
                                    <td>${user.fullName}</td>
                                    <td>${user.email}</td>
                                    <td>${user.role || 'N/A'}</td>
                                    <td><span class="status-badge ${statusClass}">${status}</span></td>
                                    <td>${user.isApproved ? 'Yes' : 'No'}</td>
                                                                        <td class="action-cell">
                                                                            ${!user.isApproved ? `
                                                                                <button class="btn btn-approve" onclick="approveUser(${user.id}, '${user.role}')">
                                                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                                                        <polyline points="20 6 9 17 4 12"></polyline>
                                                                                    </svg>
                                                                                    Approve
                                                                                </button>
                                                                                <button class="btn btn-reject" onclick="confirmRejectUser(${user.id})">
                                                                                                                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                                                                                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                                                                                                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                                                                                                                </svg>
                                                                                                                                Reject
                                                                                                                            </button>
                                                                            ` : ''}
                                                                            ${user.isLocked ? `
                                                                                <button class="btn btn-unlock" onclick="confirmToggleLockUser(${user.id}, false)">
                                                                                                                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                                                                                                    <path d="M5 13a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-6z"></path>
                                                                                                                                    <path d="M11 16a1 1 0 1 0 2 0 1 1 0 0 0-2 0"></path>
                                                                                                                                    <path d="M8 11V7a4 4 0 1 1 8 0v4"></path>
                                                                                                                                </svg>
                                                                                                                                Unlock
                                                                                                                            </button>
                                                                            ` : `
                                                                                <button class="btn btn-lock" onclick="confirmToggleLockUser(${user.id}, true)">
                                                                                                                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                                                                                                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                                                                                                                    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                                                                                                                                </svg>
                                                                                                                                Lock
                                                                                                                            </button>
                                                                            `}
                                                                        </td>
                                `;
                
                tbody.appendChild(row);
            });
        }
        
        function updateStats() {
            document.getElementById('total-users').textContent = users.length;
            document.getElementById('pending-users').textContent = users.filter(u => !u.isApproved).length;
            document.getElementById('active-users').textContent = users.filter(u => u.isApproved && !u.isLocked).length;
            document.getElementById('locked-users').textContent = users.filter(u => u.isLocked).length;
        }
        
        async function approveUser(userId, role) {
                    try {
                        const csrfToken = document.getElementById('csrf-token').value;
                        const response = await fetch('/api/admin/approve-user', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRF-Token': csrfToken
                            },
                            body: JSON.stringify({ userId, approved: true, role })
                        });
                        
                        if (!response.ok) throw new Error('Failed to approve user');
                        
                        showNotification('User approved successfully');
                        await loadUsers();
                    } catch (error) {
                        showNotification('Error approving user: ' + error.message, 'error');
                    }
                }
                
                async function confirmRejectUser(userId) {
                    if (confirm('Are you sure you want to reject this user? This action cannot be undone.')) {
                        await rejectUser(userId);
                    }
                }
        
        async function rejectUser(userId) {
                    try {
                        const csrfToken = document.getElementById('csrf-token').value;
                        const response = await fetch('/api/admin/approve-user', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRF-Token': csrfToken
                            },
                            body: JSON.stringify({ userId, approved: false })
                        });
                        
                        if (!response.ok) throw new Error('Failed to reject user');
                        
                        showNotification('User rejected successfully');
                        await loadUsers();
                    } catch (error) {
                        showNotification('Error rejecting user: ' + error.message, 'error');
                    }
                }
                
                async function confirmToggleLockUser(userId, lock) {
                    const action = lock ? 'lock' : 'unlock';
                    if (confirm(`Are you sure you want to ${action} this user?`)) {
                        await toggleLockUser(userId, lock);
                    }
                }
        
        async function toggleLockUser(userId, lock) {
                    try {
                        const csrfToken = document.getElementById('csrf-token').value;
                        const response = await fetch('/api/admin/lock-user', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRF-Token': csrfToken
                            },
                            body: JSON.stringify({ userId, locked: lock })
                        });
                        
                        if (!response.ok) throw new Error('Failed to update user lock status');
                        
                        showNotification(`User ${lock ? 'locked' : 'unlocked'} successfully`);
                        await loadUsers();
                    } catch (error) {
                        showNotification('Error updating user: ' + error.message, 'error');
                    }
                }
        
        // Load users on page load
                document.addEventListener('DOMContentLoaded', loadUsers);
                
                async function searchUsers() {
                    const searchTerm = document.getElementById('user-search').value.toLowerCase().trim();
                    if (!searchTerm) {
                        await loadUsers();
                        return;
                    }
                    
                    try {
                        const response = await fetch('/api/users');
                        if (!response.ok) throw new Error('Failed to fetch users');
                        
                        users = await response.json();
                        const filteredUsers = users.filter(user =>
                            user.fullName.toLowerCase().includes(searchTerm) ||
                            user.email.toLowerCase().includes(searchTerm) ||
                            (user.role && user.role.toLowerCase().includes(searchTerm))
                        );
                        
                        renderFilteredUsers(filteredUsers);
                        updateStats();
                    } catch (error) {
                        showNotification('Error searching users: ' + error.message, 'error');
                    }
                }
                
                function renderFilteredUsers(filteredUsers) {
                    const tbody = document.querySelector('#users-table tbody');
                    tbody.innerHTML = '';
                    
                    if (filteredUsers.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No users found</td></tr>';
                        return;
                    }
                    
                    filteredUsers.forEach(user => {
                        const row = document.createElement('tr');
                        
                        const status = user.isLocked ? 'locked' : (user.isApproved ? 'active' : 'pending');
                        const statusClass = `status-${status}`;
                        
                        row.innerHTML = `
                            <td>${user.id}</td>
                            <td>${user.fullName}</td>
                            <td>${user.email}</td>
                            <td>${user.role || 'N/A'}</td>
                            <td><span class="status-badge ${statusClass}">${status}</span></td>
                            <td>${user.isApproved ? 'Yes' : 'No'}</td>
                            <td class="action-cell">
                                ${!user.isApproved ? `
                                    <button class="btn btn-approve" onclick="approveUser(${user.id}, '${user.role}')">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <polyline points="20 6 9 17 4 12"></polyline>
                                        </svg>
                                        Approve
                                    </button>
                                    <button class="btn btn-reject" onclick="confirmRejectUser(${user.id})">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <line x1="18" y1="6" x2="6" y2="18"></line>
                                            <line x1="6" y1="6" x2="18" y2="18"></line>
                                        </svg>
                                        Reject
                                    </button>
                                ` : ''}
                                ${user.isLocked ? `
                                    <button class="btn btn-unlock" onclick="confirmToggleLockUser(${user.id}, false)">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M5 13a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-6z"></path>
                                            <path d="M11 16a1 1 0 1 0 2 0 1 1 0 0 0-2 0"></path>
                                            <path d="M8 11V7a4 4 0 1 1 8 0v4"></path>
                                        </svg>
                                        Unlock
                                    </button>
                                ` : `
                                    <button class="btn btn-lock" onclick="confirmToggleLockUser(${user.id}, true)">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                                        </svg>
                                        Lock
                                    </button>
                                `}
                            </td>
                        `;
                        
                        tbody.appendChild(row);
                    });
                }
                
                // Add event listener for Enter key in search box
                document.getElementById('user-search').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchUsers();
                    }
                });
            </script>
        </body>
        </html>
